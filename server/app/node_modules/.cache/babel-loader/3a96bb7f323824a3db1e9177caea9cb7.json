{"ast":null,"code":"/*!\n * ws: a node.js websocket client\n * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>\n * MIT Licensed\n */\nvar util = require('util');\n\nfunction BufferPool(initialSize, growStrategy, shrinkStrategy) {\n  if (this instanceof BufferPool === false) {\n    throw new TypeError(\"Classes can't be function-called\");\n  }\n\n  if (typeof initialSize === 'function') {\n    shrinkStrategy = growStrategy;\n    growStrategy = initialSize;\n    initialSize = 0;\n  } else if (typeof initialSize === 'undefined') {\n    initialSize = 0;\n  }\n\n  this._growStrategy = (growStrategy || function (db, size) {\n    return db.used + size;\n  }).bind(null, this);\n\n  this._shrinkStrategy = (shrinkStrategy || function (db) {\n    return initialSize;\n  }).bind(null, this);\n\n  this._buffer = initialSize ? new Buffer(initialSize) : null;\n  this._offset = 0;\n  this._used = 0;\n  this._changeFactor = 0;\n\n  this.__defineGetter__('size', function () {\n    return this._buffer == null ? 0 : this._buffer.length;\n  });\n\n  this.__defineGetter__('used', function () {\n    return this._used;\n  });\n}\n\nBufferPool.prototype.get = function (length) {\n  if (this._buffer == null || this._offset + length > this._buffer.length) {\n    var newBuf = new Buffer(this._growStrategy(length));\n    this._buffer = newBuf;\n    this._offset = 0;\n  }\n\n  this._used += length;\n\n  var buf = this._buffer.slice(this._offset, this._offset + length);\n\n  this._offset += length;\n  return buf;\n};\n\nBufferPool.prototype.reset = function (forceNewBuffer) {\n  var len = this._shrinkStrategy();\n\n  if (len < this.size) this._changeFactor -= 1;\n\n  if (forceNewBuffer || this._changeFactor < -2) {\n    this._changeFactor = 0;\n    this._buffer = len ? new Buffer(len) : null;\n  }\n\n  this._offset = 0;\n  this._used = 0;\n};\n\nmodule.exports = BufferPool;","map":null,"metadata":{},"sourceType":"script"}